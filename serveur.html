<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formation Serveur</title>
    <link href="css/html-css.css" rel="stylesheet">
</head>
<body>
    <H1>Formation Serveur</H1>
    <ul>
        <li><a href="#server-1">Se connecter au serveur</a></li>
        <li><a href="#server-2">Installation des packages</a></li>
        <li><a href="#server-3">Cr√©ation de la base de donn√©e</a></li>
        <li><a href="#server-4">Installation du programme</a></li>
        <li><a href="#server-5">Installation et configuration de nginx</a></li>
        <li><a href="#server-6">Installation et configuration de supervisor</a></li>
        <li><a href="#server-7">Cr√©ation du certificat SSL</a></li>
        <li><a href="#server-8">Fin</a></li>

    </ul>

    <hr id="server-1">
    <div class="title">Se connecter au serveur</div>
    <p>Commen√ßons par voir deux fa√ßons de se connecter √† un serveur, la premi√®re, en SSH via un terminal :</p>
    <div><i>terminal</i></div>
<pre><code>ssh user@adresseIP -p XXXX</code></pre>
    <p>D√©cryptons cette commande :
        <ul>
            <li>ssh : connexion via SSH</li>
            <li>user : nom d'utilisateur</li>
            <li>addressIP : adresse IP du serveur</li>
            <li>-p XXXX : nous sp√©cifions que nous nous connectons via le port XXXX</li>
        </ul>
    </p>
    <p>Il vous sera ensuite demand√© le mot de passe de l'utilisateur (rien n'appara√Æt lorsque vous le saisissez ? C'est normal !)</p>
    <p><i>"Mais o√π est ce que je r√©cup√®re ces valeur ?"</i></p>
    <p>Ces informations vous sont fournis par le loueur du serveur. Il est fortement recommand√© de ne pas conserver l'utilisateur et le port (22) par d√©faut pour se connecter en SSH, il est pr√©f√©rable d'en cr√©er de nouveaux</p>
    <p>Il est √©galement possible de se connecter via un logiciel, cela ne donne pas d'acc√®s aux commandes mais permet d'avoir un explorateur de fichier, ce qui peut simplifier certaines t√¢ches. Faisons la d√©mo avec FileZilla :</p>
    <img src="pic/filezilla.PNG" style="width:600px;">
    <p><ul>
        <li>h√¥te : l'adresse IP du serveur pr√©c√©d√© par le type de connexion (ftp://, sftp://...)</li>
        <li>nom d'utilisateur : ü§î</li>
        <li>mot de passe : ü§î</li>
        <li>port : le port de connexion</li>
    </ul></p>
    
    <hr style="border-top: dashed 1px; border-color: rgb(68, 68, 68);" id="server-2"/>
    <div class="title">Installation du programme</div>
    <p>Ok maintenant vous devriez avoir ceci :</p>
    <img src="pic/ubuntu-1.PNG" style="width:400px;">
    <p>Nous allons <u>AVANT TOUTE CHOSE</u> mettre √† jour les applications contenu sur notre serveur. C'est <u>TR√àS IMPORTANT</u> ! Installer une nouvelle application sans mettre √† jour le syst√®me peut (si vous avez tr√®s peu de chance bien entendu) planter votre serveur.</p>
    <div><i>terminal</i></div>
<pre><code>sudo apt-get update</code></pre>
    <p><i>"sudo ? apt-get ?"</i></p>
    <p>"super user do". Cela permet d'√©lever vos droits pour la commande que vous voulez saisir. Certaines commandes seront autrement refus√©es. "apt-get" est l'√©quivalent de "pip"</p>
    <p>Installons maintenant les packages n√©cessaires pour notre application (r√©pondez "oui"" partout):</p>
    <pre><code>sudo apt-get install python3-pip python3-dev libpq-dev postgresql postgresql-contrib git tree</code></pre>
    <p>Avant de passer √† la suite, installons une petite librairie python que j'aime beaucoup !</p>
    <pre><code>sudo pip install pipenv</code></pre>

    <hr style="border-top: dashed 1px; border-color: rgb(68, 68, 68);" id="server-3"/>
    <div class="title">Cr√©ation de la base de donn√©e</div>
    <p>Comme vous l'avez peut √™tre vu, nous avons install√© postgresql, il y'a une bonne raison √† √ßa : le programme utilise une base de donn√©e !</p>
    <p>Postgresql est install√© mais aucune base n'est cr√©√©, connectons nous √† postgres:</p>
    <div><i>terminal</i></div>
<pre><code>sudo -u postgres psql</code></pre>
    <p><i>"gn√© ?"</i></p>
    <p>"super user do" "avec utilisateur 'postgres' (utilisateur par d√©faut de postgresql" "connexion √† postgres".</p>
    <p>Vous voil√† connecter √† la base de donn√©e, faisons un peu de SQL, commen√ßons par configurer la base de donn√©e en UTF-8 :</p>
    <div><i>psql</i></div>
<pre><code>SET client_encoding TO 'utf8';</code></pre>
    <p>On doit √©galement donner un mot de passe √† l'utilisateur "postgres" (c'est obligatoire vis √† vis de l'application)</p>
    <div><i>psql</i></div>
<pre><code>ALTER ROLE postgres PASSWORD 'motdepasse';</code></pre>
    <p>Maintenant cr√©ons la base de donn√©e :</p>
    <div><i>psql</i></div>
<pre><code>CREATE DATABASE nomdelabasededonn√©e;</code></pre>
    <p>Vous pouvez √† pr√©sent quitter PSQL en tapant :</p>
    <div><i>psql</i></div>
<pre><code>exit</code></pre>
    <hr style="border-top: dashed 1px; border-color: rgb(68, 68, 68);" id="server-4"/>
    <div class="title">Installation du programme</div>
    <p>Installons √† pr√©sent l'application via git, on commence par initialiser git :</p>
    <div><i>terminal</i></div>
<pre><code>sudo git init</code></pre>
    <p>Maintenant on pull le repository :</p>
    <div><i>terminal</i></div>
<pre><code>sudo git pull adressedurepo</code></pre>
    <p>On saisit le nom d'utilisateur puis le mot de passe et notre application est install√©e ! Vous pouvez v√©rifier que tout y est avec :</p>
    <div><i>terminal</i></div>
<pre><code>tree -L 1</code></pre>
    <p>On peut d√©sormais cr√©er notre environnement virtuel (pipenv installe automatiquement toutes les librairies contenues dans le fichier requirements.txt)</p>
    <div><i>terminal</i></div>
<pre><code>pipenv install</code></pre>
    <p>Une application Django g√®re ses fichiers statiques (CSS, images etc.) d'une fa√ßon bien particuli√®re, la commande suivante est n√©cessaire :</p>
    <div><i>terminal</i></div>
<pre><code>pipenv run python manage.py collectstatic</code></pre>
    <p>Nous y sommes presque ! Avant derni√®re √©tape : remplir notre base de donn√©e avec les mod√®les cr√©√©s dans l'application :</p>
    <div><i>terminal</i></div>
<pre><code>pipenv run python manage.py migrate</code></pre>
    <p>Cr√©ons notre compte super utilisateur :</p>
    <div><i>terminal</i></div>
<pre><code>pipenv run python manage.py createsuperuser</code></pre>
    <p>Et pour finir, v√©rifions que tout est ok en lan√ßant notre application !</p>
    <div><i>terminal</i></div>
<pre><code>pipenv run python manage.py runserver</code></pre>
    <p>Si aucun message d'erreur n'apparait, c'est gagn√©, votre application fonctionne ! (vous pouvez faire "Ctrl+C" pour quitter le process)</p>
    <p><i>"Mais comment on fait pour la voir ?"</i></p>
    <hr style="border-top: dashed 1px; border-color: rgb(68, 68, 68);" id="server-5"/>
    <div class="title">Installation et configuration de nginx</div>
    <p>Vous ne pouvez √©videmment pas vous connecter √† votre application puisqu'elle fonctionne en local sur votre serveur. Il faut un pont entre les deux pour transf√©rer les requ√™tes effectu√©es depuis l'adresse IP publique jusqu'√† l'adresse IP priv√©e. On s'agit d'un <b>serveur web</b> ou <b>serveur HTTP</b></p>
    <p>Il en existe plusieurs (les plus connus √©tant Apache et Nginx). Nous utiliserons Nginx ! Commen√ßons par l'installer :</p>
    <div><i>terminal</i></div>
<pre><code>sudo apt-get install nginx</code></pre>
    <p>Essayez de vous connecter √† l'adresse IP du serveur, voici ce que vous devriez voir :</p>
    <img src="pic/nginx.PNG" style="width:600px;">
    <p>Cr√©ons un fichier de configuration pour Nginx :</p>
    <div><i>terminal</i></div>
<pre><code>sudo touch /etc/nginx/sites-available/nomdelapplication</code></pre>
    <p>Ensuite nous devons dire √† Nginx de prendre en compte ce fichier de configuration en ajoutant un lien symbolique dans sites-enabled:</p>
    <div><i>terminal</i></div>
<pre><code>sudo ln -s /etc/nginx/sites-available/nomdelapplication /etc/nginx/sites-enabled</code></pre>
    <p>Attention √ßa devient technique ! Nous allons lier le trafic entrant √† l'application Django. Celle-ci contient trois formats de fichiers diff√©rents :
        <ul>
            <li>les fichiers statiques</li>
            <li>les fichiers m√©dias</li>
            <li>les fichiers dynamiques</li>
        </ul>
    </p>
    <p>On demande les choses suivantes √† Nginx :
        <ul>
            <li>si un fichier statique est demand√©, affiche-le sans passer par l'application</li>
            <li>si un fichier media est demand√©, affiche-le sans passer par l'application</li>
            <li>sinon, redirige le trafic vers l'application Django</li>
        </ul>
    </p>
    <p>Lorsqu'un fichier est renvoy√©, on dit qu'il est "servi" par le serveur. Par exemple : "servir les fichiers statiques".</p>
    <p>Dans notre cas, nous avons install√© une libraire (Whitenoise) qui nous permet d'√™tre feignant avec les fichiers statiques, nous avons juste √† g√©rer les m√©dias et le reste.</p>
    <p>Acc√©dons √† notre fichier de configuration :</p>
    <div><i>terminal</i></div>
<pre><code>sudo nano /etc/nginx/sites-available/nomdelapplication</code></pre>
    <p>Entrez ensuite les donn√©es suivantes : (pour enregistrer et quitter le fichier, Ctrl+X et 2 fois Entr√©e)</p>
    <div><i>nomdelapplication</i></div>
<pre><code>server { server_name adresseIPduserveur;

    location / {
            proxy_set_header Host $http_host;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_redirect off;
            proxy_pass http://127.0.0.1:8000;
    }

    location /media {
            alias /home/ubuntu/media;
    }
}</code></pre>
    <p><i>"Oulalah !"</i></p>
    <p>Mais non ! D√©cryptons :
        <ul>
            <li>server_name : nom du serveur, cel√† peut √™tre son adresse IP ou un nom de domaine</li>
            <li>location / : si la requ√™te ne concerne ni un fichier statique, ni un fichier m√©dia, elle sera servi selon les param√®tres qui suivront</li>
            <li>proxy_set_header : options n√©cessaires √† l'utilisation de django (modifie les param√®tres du header)</li>
            <li>proxy_redirect : j'ai pas trouv√© !</li>
            <li>proxy_pass : nginx redirigera les requ√™tes entrantes vers l'adresse locale indiqu√©es. Dans notre cas, 127.0.0.1:8000 est l'adresse par d√©faut d'un serveur Django !</li>
            <li>location /media : si la requ√™te concerne un fichier m√©dia...</li>
            <li>alias : ...Nginx √©tablira un lien avec ce dossier !</li>
        </ul>
    </p>
    <p>On recharge Nginx :</p>
    <div><i>terminal</i></div>
<pre><code>sudo service nginx reload</code></pre>
    <p>On relance notre serveur :</p>
    <div><i>terminal</i></div>
<pre><code>pipenv run python manage.py runserver</code></pre>
    <p>On se connecte √† l'adresse IP eeeeeet...</p>
    <p><i>"√áa ne marche pas, j'ai une erreur 400..."</i></p>
    <p>Ah oui... c'est parce que l'adresse IP du serveur n'a pas √©t√© configur√©e dans le param√®tre ALLOWED_HOSTS de l'application Django.</p>
    <p>Ce param√®tre se trouve normalement dans le fichier de settings de l'application mais dans le cas pr√©sent, il se trouve dans le fichier environment.py. Ouvrez ce fichier puis ajouter l'adresse IP du serveur dans la liste "ALLOWED_HOSTS" !</p>
    <div><i>terminal</i></div>
<pre><code>sudo nano environment.py</code></pre>
    <p>Relancez le serveur, retournez sur le site et normalement, tout y est.</p>

    <hr style="border-top: dashed 1px; border-color: rgb(68, 68, 68);" id="server-6"/>
    <div class="title">Installation et configuration de supervisor</div>
    <p>On a presque termin√© : on va maintenant s'assurer qu'en cas de crash, notre serveur se relance bien automatiquement, pour ce, on va utiliser supervisor, installons le :</p>
    <div><i>terminal</i></div>
<pre><code>sudo apt-get install supervisor</code></pre>
    <p>On cr√©√© ensuite le fichier de configuration pour notre application :</p>
    <div><i>terminal</i></div>
<pre><code>sudo nano /etc/supervisor/conf.d/nomdelapplication.conf</code></pre>
    <p>Et entrez ceci :</p>
    <div><i>nomdelapplication.conf</i></div>
<pre><code>[program:nomdelapplication]
command = pipenv run gunicorn nomdelapplication.wsgi:application
user = utilisateurserveur
directory = /home/ubuntu
autostart = true
autorestart = true</code></pre>
    <p>Qu-est ce que √ßa raconte ?
        <ul>
            <li>command : la commande qui sera execut√©e par supervisor</li>
            <li>user : l'utilisateur pour qui supervisor se fera passer</li>
            <li>directory : le dossier d'execution de la commande</li>
            <li>autostart : permet √† la commande de se lancer automatiquement</li>
            <li>autorestart : permet √† la commande de se relancer automatiquement</li>
        </ul>
    </p>
    <p><i>"Guniquoi ?"</i></p>
    <p>Gunicorn ! C'est un serveur HTTP Python pour Unix qui utilise les sp√©cifications WSGI (Web Server Gateway Interface). En production, il n'est pas recommand√© de lancer son serveur Django directement via la commande runserver (c'est fortement d√©conseill√© par les d√©veloppeur du framework). Il est pr√©f√©rable d'utiliser un outil plus puissant et plus performant. Gunicorn est l'un de ces outils.</p>
    <p>Il est temps de dire √† Supervisor de lancer les processus, on commence par lui faire contr√¥ler nos fichiers de configuration :</p>
    <div><i>terminal</i></div>
<pre><code>sudo supervisorctl reread</code></pre>
    <p>Puis on le remet √† jour :</p>
    <div><i>terminal</i></div>
<pre><code>sudo supervisorctl update</code></pre>
    <p>Enfin, on v√©rifie que le processus est bien lanc√© :</p>
    <div><i>terminal</i></div>
<pre><code>sudo supervisorctl status</code></pre>
    <p>Si RUNNING apparait, vous pouvez retourner sur votre navigateur pour v√©rifier que l'application fonctionne bien !</p>
    <div><i>autres commandes supervisor</i></div>
<pre><code>sudo supervisorctl start nomdelapplication
sudo supervisorctl stop nomdelapplication
sudo supervisorctl restart nomdelapplication</code></pre>

    <hr style="border-top: dashed 1px; border-color: rgb(68, 68, 68);" id="server-7"/>
    <div class="title">Cr√©ation du certificat SSL</div>
    <p>Pour achever le travail, nous allons lier notre application √† un nom de domaine et cr√©er un certificat SSL. On doit commencer par modifier notre fichier de configuration nginx pour ajouter le nom de domaine :</p>
    <div><i>terminal</i></div>
<pre><code>sudo nano /etc/nginx/sites-available/nomdelapplication</code></pre>
    <p>On modifie le param√®tre server_name :</p>
    <div><i>nomdelapplication</i></div>
<pre><code>server { server_name adresseIPduserveur nomdedomaine.xx www.nomdedomaine.xx;

    location / {
            proxy_set_header Host $http_host;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_redirect off;
            proxy_pass http://127.0.0.1:8000;
    }

    location /media {
            alias /home/ubuntu/media;
    }
}</code></pre>
    <p>On sauvegarde et on pr√©pare directement la cr√©ation du certificat SSL. Nous allons utiliser Certbot pour cr√©er un certificat SSL gratuit, celui-ci doit √™tre install√© via la librairie snap (√©quivalent de pip) que nous devons installer au pr√©alable :</p>
    <div><i>terminal</i></div>
<pre><code>sudo apt-get install snapd</code></pre>
    <p>On s'assure ensuite que snap soit bien √† jour :</p>
    <div><i>terminal</i></div>
<pre><code>sudo snap install core; sudo snap refresh core</code></pre>
    <p>On v√©rifie qu'il n'y ai pas de version auto de Certbot d√©j√† install√©e:</p>
    <div><i>terminal</i></div>
<pre><code>sudo apt-get remove certbot</code></pre>
    <p>On installe Certbot :</p>
    <div><i>terminal</i></div>
<pre><code>sudo snap install --classic certbot</code></pre>
    <p>On lance la commande suivante afin de s'assurer que Certbot fonctionnera bien :</p>
    <div><i>terminal</i></div>
<pre><code>sudo ln -s /snap/bin/certbot /usr/bin/certbot</code></pre>
    <p>On cr√©√© le certificat (pour une config nginx):</p>
    <div><i>terminal</i></div>
<pre><code>sudo certbot --nginx</code></pre>
    <p>Et c'est fini ! Votre certificat est cr√©√©. Il peut mettre un certain temps √† √™tre d√©ploy√© ! Vous pouvez v√©rifier les param√®tres ajout√©s en vous rendant sur le fichier de config Nginx :</p>
    <div><i>terminal</i></div>
<pre><code>sudo nano /etc/nginx/sites-available/nomdelapplication</code></pre>
    <p>Essayez de vous connecter √† votre nom de domaine via https (il faudra peut √™tre attendre quelques minutes)</p>
    <hr style="border-top: dashed 1px; border-color: rgb(68, 68, 68);" id="server-7"/>
    <div class="title">Fin de la formation</div>
    <p>F√©licitation ! Vous avez d√©ploy√© une application de A √† Z et √™tes plus √† m√™me de savoir comment agir en cas de probl√®me !</p>
</body>
</html>

